From 2813b6dfd4676a1cc84d4f19577ef343bec1fe49 Mon Sep 17 00:00:00 2001
From: GloriousEggroll <gloriouseggroll@gmail.com>
Date: Fri, 13 Feb 2026 22:23:21 -0700
Subject: [PATCH] HACK: Force Vermintide 2 current working directory to game
 folder instead of launcher folder for EAC

Vermintide 2's launcher runs from <game folder>/launcher/Launcher.exe,
 it then launches the EAC versions of the game using '../start_protected_game.exe' <args>.

The problem is that when it's launched this way it keeps the current working
directory set as <game folder>/launcher, while the start_protected_game.exe
and EAC files reside in <game folder>, thus start_protected_game.exe
and subsequently EAC expect to read files from <game folder>, -not-
<game folder>/launcher/. Since the current working directory is set as
<game folder>/launcher by the launcher, it breaks EAC's file reading.

This patch checks for vermintide 2 if 'start_protected_game.exe' is called
then forces the current working directory to <game folder> instead of
<game folder>/launcher, allowing EAC to work when run from the launcher.
---
 dlls/kernelbase/process.c | 30 ++++++++++++++++++++++++++++++
 1 file changed, 30 insertions(+)

diff --git a/dlls/kernelbase/process.c b/dlls/kernelbase/process.c
index dd07c075c10..488b2e89650 100644
--- a/dlls/kernelbase/process.c
+++ b/dlls/kernelbase/process.c
@@ -745,6 +745,36 @@ BOOL WINAPI DECLSPEC_HOTPATCH CreateProcessInternalW( HANDLE token, const WCHAR
     if (battleye_launcher_redirect_hack( app_name, name, ARRAY_SIZE(name), &orig_app_name, product_name ))
         app_name = name;
 
+    /* Warhammer Vermintide 2 Directory Correction Hack (Steam AppID 552500) */
+    {
+        char sgi[64] = {0};
+        GetEnvironmentVariableA("SteamGameId", sgi, sizeof(sgi));
+
+        /* If this is Vermintide 2 and we are launching the protected game... */
+        if (!strcmp(sgi, "552500") && tidy_cmdline && wcsstr(tidy_cmdline, L"start_protected_game.exe"))
+        {
+            static WCHAR root_path[MAX_PATH];
+            WCHAR *dir_sep;
+
+            /* 1. Get the current directory (which is currently .../launcher/) */
+            if (GetCurrentDirectoryW(MAX_PATH, root_path))
+            {
+                /* 2. Find the last backslash and check if we are in the launcher folder */
+                dir_sep = wcsrchr(root_path, L'\\');
+                if (dir_sep && !wcsicmp(dir_sep, L"\\launcher"))
+                {
+                    /* 3. Strip "\launcher" to move the working directory to the Game Root */
+                    *dir_sep = L'\0';
+
+                    /* 4. Apply the fix to the actual process creation parameter */
+                    cur_dir = root_path;
+
+                    FIXME("Vermintide 2: Corrected Working Directory to %s\n", debugstr_w(cur_dir));
+                }
+            }
+        }
+    }
+
     /* Warn if unsupported features are used */
 
     if (flags & (IDLE_PRIORITY_CLASS | HIGH_PRIORITY_CLASS | REALTIME_PRIORITY_CLASS |
-- 
2.53.0

