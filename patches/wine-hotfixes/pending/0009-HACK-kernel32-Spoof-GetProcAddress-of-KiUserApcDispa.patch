From c4dec62a090dacb23b7ae5ede5bdf1fc93b75fc8 Mon Sep 17 00:00:00 2001
From: Ziia Shi <mkrsym1@gmail.com>
Date: Tue, 20 Jan 2026 16:33:26 +0100
Subject: [PATCH 1/3] HACK: kernel32: Spoof GetProcAddress of
 KiUserApcDispatcher and KiUserCallbackDispatcher.

---
 dlls/kernel32/module.c | 19 +++++++++++++++++++
 1 file changed, 19 insertions(+)

diff --git a/dlls/kernel32/module.c b/dlls/kernel32/module.c
index ed15e57c29c..fcc7e6e7c5b 100644
--- a/dlls/kernel32/module.c
+++ b/dlls/kernel32/module.c
@@ -262,6 +262,21 @@ BOOL WINAPI GetBinaryTypeA( LPCSTR lpApplicationName, LPDWORD lpBinaryType )
     return GetBinaryTypeW(NtCurrentTeb()->StaticUnicodeString.Buffer, lpBinaryType);
 }
 
+static void __attribute__((naked)) int3_stub( void )
+{
+#if defined(__arm64ec__) || defined(_M_ARM64EC) || defined(__aarch64__) || defined(_M_ARM64)
+    asm("brk #0\t\n"
+        "brk #0\t\n"
+        "brk #0\t\n"
+        "brk #0\t\n");
+#else
+    asm("int3\t\n"
+        "int3\t\n"
+        "int3\t\n"
+        "int3\t\n");
+#endif
+}
+
 /***********************************************************************
  *           GetProcAddress   		(KERNEL32.@)
  *
@@ -284,6 +299,15 @@ FARPROC get_proc_address( HMODULE hModule, LPCSTR function )
     if ((ULONG_PTR)function >> 16)
     {
         ANSI_STRING     str;
+        char sgi[64];
+        DWORD n = GetEnvironmentVariableA("PROTON_ENABLE_INT3_HACK", sgi, sizeof(sgi));
+
+        BOOL needs_int3_hack = (n > 0 && n < sizeof(sgi) && strcmp(sgi, "1") == 0);
+        if (needs_int3_hack && (strcmp( function, "KiUserApcDispatcher" ) == 0 || strcmp( function, "KiUserCallbackDispatcher" ) == 0))
+        {
+            FIXME( "HACK: returning int3 stub instead of %s\n", function );
+            return (FARPROC)&int3_stub;
+        }
 
         RtlInitAnsiString( &str, function );
         if (!set_ntstatus( LdrGetProcedureAddress( hModule, &str, 0, (void**)&fp ))) return NULL;
-- 
2.52.0

