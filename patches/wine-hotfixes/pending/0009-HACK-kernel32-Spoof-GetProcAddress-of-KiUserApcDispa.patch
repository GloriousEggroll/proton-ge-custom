From c4dec62a090dacb23b7ae5ede5bdf1fc93b75fc8 Mon Sep 17 00:00:00 2001
From: Ziia Shi <mkrsym1@gmail.com>
Date: Tue, 20 Jan 2026 16:33:26 +0100
Subject: [PATCH 1/3] HACK: kernel32: Spoof GetProcAddress of
 KiUserApcDispatcher and KiUserCallbackDispatcher.

---
 dlls/kernel32/module.c | 19 +++++++++++++++++++
 1 file changed, 19 insertions(+)

diff --git a/dlls/kernel32/module.c b/dlls/kernel32/module.c
index ed15e57c29c..ac72f03cf0a 100644
--- a/dlls/kernel32/module.c
+++ b/dlls/kernel32/module.c
@@ -262,6 +262,48 @@ BOOL WINAPI GetBinaryTypeA( LPCSTR lpApplicationName, LPDWORD lpBinaryType )
     return GetBinaryTypeW(NtCurrentTeb()->StaticUnicodeString.Buffer, lpBinaryType);
 }
 
+static BOOL needs_int3_hack(void)
+{
+    static volatile char cache = -1;
+    BOOL ret = cache;
+    if (ret == -1)
+    {
+        const WCHAR *p, *name = NtCurrentTeb()->Peb->ProcessParameters->ImagePathName.Buffer;
+        if ((p = wcsrchr(name, '/')))
+            name = p + 1;
+        if ((p = wcsrchr(name, '\\')))
+            name = p + 1;
+
+        ret = (!wcsicmp(name, L"Endfield.exe"));
+        cache = ret;
+    }
+    return ret;
+}
+
+/* workaround for tpshell */
+#if defined(__arm64ec__) || defined(_M_ARM64EC) || defined(__aarch64__)
+static void __attribute__((naked)) int3_stub( void )
+{
+    __asm__ __volatile__("brk #0\t\n"
+                         "brk #0\t\n"
+                         "brk #0\t\n"
+                         "brk #0\t\n");
+}
+#elif defined(__x86_64__) || defined(__i386__)
+static void __attribute__((naked)) int3_stub( void )
+{
+    __asm__ __volatile__("int3\t\n"
+                         "int3\t\n"
+                         "int3\t\n"
+                         "int3\t\n");
+}
+#else
+static void int3_stub( void )
+{
+    __builtin_trap();
+}
+#endif
+
 /***********************************************************************
  *           GetProcAddress   		(KERNEL32.@)
  *
@@ -285,6 +327,12 @@ FARPROC get_proc_address( HMODULE hModule, LPCSTR function )
     {
         ANSI_STRING     str;
 
+        if (needs_int3_hack() && (strcmp( function, "KiUserApcDispatcher" ) == 0 || strcmp( function, "KiUserCallbackDispatcher" ) == 0))
+        {
+            FIXME( "HACK: returning int3 stub instead of %s\n", function );
+            return (FARPROC)&int3_stub;
+        }
+
         RtlInitAnsiString( &str, function );
         if (!set_ntstatus( LdrGetProcedureAddress( hModule, &str, 0, (void**)&fp ))) return NULL;
     }
-- 
2.52.0

