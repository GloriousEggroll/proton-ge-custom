From cc9092cd66dc8a7abb65efa0bea7c63233b9e44a Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Thu, 14 Aug 2025 14:17:41 -0400
Subject: [PATCH 268/486] ntoskrnl: Fixup PsGetCurrentThreadTeb.

---
 dlls/ntoskrnl.exe/ntoskrnl.c         | 3 ++-
 dlls/ntoskrnl.exe/ntoskrnl_private.h | 1 +
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/dlls/ntoskrnl.exe/ntoskrnl.c b/dlls/ntoskrnl.exe/ntoskrnl.c
index cd67af78ab0..7c4e5ad0a3f 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.c
+++ b/dlls/ntoskrnl.exe/ntoskrnl.c
@@ -2654,6 +2654,7 @@ static void *create_thread_object( HANDLE handle )
     if (!NtQueryInformationThread( handle, ThreadBasicInformation, &info, sizeof(info), NULL ))
     {
         thread->id = info.ClientId;
+        thread->teb = info.TebBaseAddress;
         if ((process = OpenProcess( PROCESS_QUERY_INFORMATION, FALSE, HandleToUlong(thread->id.UniqueProcess) )))
         {
             kernel_object_from_handle( process, PsProcessType, (void**)&thread->process );
@@ -3462,7 +3463,7 @@ HANDLE WINAPI PsGetCurrentThreadId(void)
  */
 TEB *WINAPI PsGetCurrentThreadTeb(void)
 {
-    return NtCurrentTeb();
+    return KeGetCurrentThread()->teb;
 }
 
 /***********************************************************************
diff --git a/dlls/ntoskrnl.exe/ntoskrnl_private.h b/dlls/ntoskrnl.exe/ntoskrnl_private.h
index 561d6f0c1b4..3d508a911de 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl_private.h
+++ b/dlls/ntoskrnl.exe/ntoskrnl_private.h
@@ -69,6 +69,7 @@ struct _KTHREAD
     CLIENT_ID id;
     unsigned int critical_region;
     KAFFINITY user_affinity;
+    void *teb;
 };
 
 struct _ETHREAD
-- 
2.53.0

