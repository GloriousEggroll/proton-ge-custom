From c756ebfca8fcf502cc903e56352c6070ad9fe6d1 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Thu, 29 Jan 2026 23:32:41 -0600
Subject: [PATCH 478/486] fixup! ntoskrnl: Fix calling convention for guarded
 mutex methods.

---
 dlls/ntoskrnl.exe/ntoskrnl.exe.spec | 10 +++++-----
 dlls/ntoskrnl.exe/sync.c            | 15 ++++++++++-----
 2 files changed, 15 insertions(+), 10 deletions(-)

diff --git a/dlls/ntoskrnl.exe/ntoskrnl.exe.spec b/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
index 267b4d6dfb7..c6aad9a3ea5 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
+++ b/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
@@ -54,16 +54,16 @@
 @ stdcall -fastcall IofCompleteRequest(ptr long)
 @ stdcall -arch=!i386 KeAcquireInStackQueuedSpinLock(ptr ptr)
 @ stdcall -fastcall KeAcquireInStackQueuedSpinLockAtDpcLevel(ptr ptr)
-@ stdcall KeAcquireGuardedMutexUnsafe(ptr)
-@ stdcall KeAcquireGuardedMutex(ptr)
+@ stdcall -fastcall KeAcquireGuardedMutexUnsafe(ptr)
+@ stdcall -fastcall KeAcquireGuardedMutex(ptr)
 @ stdcall KeEnterGuardedRegion()
 @ stdcall KeExpandKernelStackAndCallout(ptr ptr long)
 @ stdcall KeExpandKernelStackAndCalloutEx(ptr ptr long long ptr)
 @ stdcall KeLeaveGuardedRegion()
 @ stdcall -arch=!i386 KeReleaseInStackQueuedSpinLock(ptr)
 @ stdcall -fastcall KeReleaseInStackQueuedSpinLockFromDpcLevel(ptr)
-@ stdcall KeReleaseGuardedMutexUnsafe(ptr)
-@ stdcall KeReleaseGuardedMutex(ptr)
+@ stdcall -fastcall KeReleaseGuardedMutexUnsafe(ptr)
+@ stdcall -fastcall KeReleaseGuardedMutex(ptr)
 @ stub KeSetTimeUpdateNotifyRoutine
 @ stub KefAcquireSpinLockAtDpcLevel
 @ stub KefReleaseSpinLockFromDpcLevel
@@ -587,7 +587,7 @@
 @ stub KeInitializeInterrupt
 @ stub KeInitializeMutant
 @ stdcall KeInitializeMutex(ptr long)
-@ stdcall KeInitializeGuardedMutex(ptr)
+@ stdcall -fastcall KeInitializeGuardedMutex(ptr)
 @ stub KeInitializeQueue
 @ stdcall KeInitializeSemaphore(ptr long long)
 @ stdcall KeInitializeSpinLock(ptr) NTOSKRNL_KeInitializeSpinLock
diff --git a/dlls/ntoskrnl.exe/sync.c b/dlls/ntoskrnl.exe/sync.c
index 103feee023e..1729ec105a4 100644
--- a/dlls/ntoskrnl.exe/sync.c
+++ b/dlls/ntoskrnl.exe/sync.c
@@ -428,7 +428,8 @@ LONG WINAPI KeReleaseMutex( PRKMUTEX mutex, BOOLEAN wait )
 /***********************************************************************
  *           KeInitializeGuardedMutex   (NTOSKRNL.EXE.@)
  */
-void WINAPI KeInitializeGuardedMutex(PKGUARDED_MUTEX mutex)
+DEFINE_FASTCALL1_WRAPPER(KeInitializeGuardedMutex)
+void FASTCALL KeInitializeGuardedMutex(PKGUARDED_MUTEX mutex)
 {
     TRACE("mutex %p.\n", mutex);
     mutex->Count = FM_LOCK_BIT;
@@ -440,7 +441,8 @@ void WINAPI KeInitializeGuardedMutex(PKGUARDED_MUTEX mutex)
 /***********************************************************************
  *           KeAcquireGuardedMutexUnsafe   (NTOSKRNL.EXE.@)
  */
-void WINAPI KeAcquireGuardedMutexUnsafe(PKGUARDED_MUTEX mutex)
+DEFINE_FASTCALL1_WRAPPER(KeAcquireGuardedMutexUnsafe)
+void FASTCALL KeAcquireGuardedMutexUnsafe(PKGUARDED_MUTEX mutex)
 {
     LONG count;
 
@@ -454,7 +456,8 @@ void WINAPI KeAcquireGuardedMutexUnsafe(PKGUARDED_MUTEX mutex)
 /***********************************************************************
  *           KeAcquireGuardedMutex   (NTOSKRNL.EXE.@)
  */
-void WINAPI KeAcquireGuardedMutex(PKGUARDED_MUTEX mutex)
+DEFINE_FASTCALL1_WRAPPER(KeAcquireGuardedMutex)
+void FASTCALL KeAcquireGuardedMutex(PKGUARDED_MUTEX mutex)
 {
     /* FIXME: Enter Guarded Region */
     KeAcquireGuardedMutexUnsafe(mutex);
@@ -463,7 +466,8 @@ void WINAPI KeAcquireGuardedMutex(PKGUARDED_MUTEX mutex)
 /***********************************************************************
  *           KeReleaseGuardedMutexUnsafe   (NTOSKRNL.EXE.@)
  */
-void WINAPI KeReleaseGuardedMutexUnsafe(PKGUARDED_MUTEX mutex)
+DEFINE_FASTCALL1_WRAPPER(KeReleaseGuardedMutexUnsafe)
+void FASTCALL KeReleaseGuardedMutexUnsafe(PKGUARDED_MUTEX mutex)
 {
     LONG count;
 
@@ -477,7 +481,8 @@ void WINAPI KeReleaseGuardedMutexUnsafe(PKGUARDED_MUTEX mutex)
 /***********************************************************************
  *           KeReleaseGuardedMutex   (NTOSKRNL.EXE.@)
  */
-void WINAPI KeReleaseGuardedMutex(PKGUARDED_MUTEX mutex)
+DEFINE_FASTCALL1_WRAPPER(KeReleaseGuardedMutex)
+void FASTCALL KeReleaseGuardedMutex(PKGUARDED_MUTEX mutex)
 {
     KeReleaseGuardedMutexUnsafe(mutex);
     /* FIXME: Leave Guarded Region */
-- 
2.53.0

